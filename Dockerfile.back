FROM node:22

WORKDIR /app

# Install dependencies
COPY back/package*.json ./
RUN npm install

# Copy source
COPY back /app

# Build the app
RUN npm run build

# Copy static into build output so it's served via Adonis routes
RUN mkdir -p build && cp -r static build/static

# Prune dev deps to slim image
RUN npm prune --omit=dev

# Install PM2 globally
RUN npm install -g pm2

EXPOSE 3333

# Start with PM2
CMD ["pm2-runtime", "build/bin/server.js", "--name", "colonizadar"]
